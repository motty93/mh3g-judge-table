<!DOCTYPE html>
<html lang="ja" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>砂原採取 判定マクロ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.2/dist/htmx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.5/dist/cdn.min.js" defer></script>
  <style>
    html {
      font-size: 87.5%;
    }

  </style>
</head>

<body x-data="judgeApp">
  <main class="container">
    <h1>砂原採取マクロ 判定法</h1>

    <form @submit.prevent="runJudgement">
      <h2>各回の報酬パターン入力</h2>
      <table>
        <thead>
          <tr>
            <th>回数</th>
            <th>スキル</th>
            <th>1枠目 (固定)</th>
            <template x-for="i in 6">
              <th><span x-text="i + 1 + '枠'"></span></th>
            </template>
          </tr>
        </thead>
        <tbody>
          <template x-for="(trial, t) in patterns" :key="t">
            <tr>
              <td x-text="t + 1 + '回目'"></td>
              <td>
                <select x-model="trial.skill">
                  <option>なし</option>
                  <option>幸運</option>
                  <option>激運</option>
                </select>
              </td>
              <td>
                <select x-model="trial.slots[0]" disabled>
                  <option value=""></option>
                  <option>釣りミミズ</option>
                  <option>生肉</option>
                  <option>砥石</option>
                </select>
              </td>
              <template x-for="i in 6" :key="i">
                <td>
                  <select x-model="trial.slots[i]">
                    <option value=""></option>
                    <option>釣りミミズ</option>
                    <option>生肉</option>
                    <option>砥石</option>
                  </select>
                </td>
              </template>
            </tr>
          </template>
        </tbody>
      </table>

      <button type="submit">判定実行</button>
    </form>

    <div class="result" x-show="result">
      <h2>判定結果</h2>
      <p><mark><span x-text="result"></span></mark></p>
    </div>
  </main>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('judgeApp', () => ({
        rewards: [{
            name: '釣りミミズ',
            start: 0,
            end: 49
          },
          {
            name: '生肉',
            start: 50,
            end: 74
          },
          {
            name: '砥石',
            start: 75,
            end: 99
          }
        ],
        patterns: Array.from({
          length: 3
        }, () => ({
          skill: 'なし',
          slots: Array(7).fill('')
        })),
        result: '',
        seedData: [],
        loading: true,
        init() {
          this.loadSeedData();
        },
        async loadSeedData() {
          try {
            const response = await fetch('./table-seed.csv');
            const csvText = await response.text();
            // CSVのヘッダーをスキップし、各行を数値の配列に変換
            this.seedData = csvText.trim().split('\n').slice(1).map(row => row.split(',').map(Number));
          } catch (error) {
            console.error('シードデータの読み込みに失敗しました:', error);
            this.result = 'エラー: シードデータを読み込めませんでした。';
          } finally {
            this.loading = false;
          }
        },
        runJudgement() {
          if (this.loading) return;

          const skillToLack = {
            'なし': 22,
            '幸運': 26,
            '激運': 29
          };
          const FIXED_CONSUME = 32;
          const TABLE_COUNT = 17;
          const candidateTables = [];

          // table-seed.csvの各列がT1, T2, ...に対応する
          for (let t = 0; t < TABLE_COUNT; t++) {
            let ptr = 0; // CSVデータの行インデックス
            let match = true;

            for (const trial of this.patterns) {
              const lack = skillToLack[trial.skill];

              // 2枠目から7枠目までをチェック (1枠目は固定なのでスキップ)
              for (const rewardName of trial.slots.slice(1)) {
                // スカ判定
                const skaval = this.seedData[ptr] ? this.seedData[ptr][t] % 32 : -1;
                ptr++;
                if (skaval === -1) { // データ範囲外
                  match = false;
                  break;
                }

                if (skaval >= lack) { // スカ
                  if (rewardName !== '') {
                    match = false;
                    break;
                  }
                  continue; // スカ成功、次の枠へ
                }

                // 報酬判定
                const val = this.seedData[ptr] ? this.seedData[ptr][t] : -1;
                ptr++;
                if (val === -1) { // データ範囲外
                  match = false;
                  break;
                }

                const reward = this.rewards.find(r => r.name === rewardName);
                if (!reward) { // 入力が空欄の場合（スカではない）
                  match = false;
                  break;
                }
                if (val < reward.start || val > reward.end) {
                  match = false;
                  break;
                }
              }

              if (!match) break;
              ptr += FIXED_CONSUME; // クエスト間の固定消費
            }

            if (match) {
              candidateTables.push(`T${t + 1}`);
            }
          }

          this.result = candidateTables.length > 0 ?
            `候補テーブル: ${candidateTables.join(', ')}` :
            '該当テーブルなし';
        }
      }))
    })
  </script>
</body>

</html>
