# MH3G 砂原採取マクロ ロジック解説

## 概要

このVBAマクロ `allkensaku` は、ExcelのSheet1に入力された情報をもとに、モンスターハンター3Gにおける「お守りテーブル」を特定するためのツールです。港★1の砂原採取ツアーをクリアした際に得られる報酬アイテムのパターンから、プレイヤーがT1からT17までのどの乱数テーブルに属しているかを判定します。

## 主な処理の流れ

処理は以下のステップで進行します。

### 1. 初期設定とデータ読み込み

マクロはまず、計算を高速化するためにExcelの自動計算を一時的に停止します。その後、以下の情報をSheet1およびSheet2から読み込みます。

-   **Sheet1から読み込むデータ:**
    -   **報酬アイテム情報 (A3:B5):** 報酬として出現する可能性のあるアイテム（釣りミミズ、生肉、砥石）と、それに対応する内部的な抽選確率（重み）。
    -   **固定消費値 (B12):** クエストクリアごとに消費される固定の乱数値。
    -   **試行回数 (E10):** ユーザーが入力したクエストの試行回数。
    -   **報酬��ターン (E3から始まる範囲):** ユーザーが各クエストで得た報酬アイテムのリスト。
    -   **スキル情報 (L3から始まる範囲):** 各クエストで発動していたスキル（激運、幸運、なし）。スキルは報酬の抽選確率に影響します。
-   **Sheet2から読み込むデータ:**
    -   **乱数シードテーブル (A2:Q5401):** T1からT17までの17個のテーブルに対応する、事前に計算された乱数のリスト。

### 2. 入力データの内部形式への変換

ユーザーが入力した報酬アイテム名（例: "釣りミミズ"）を、マクロが処理しやすい内部的な抽選範囲（例: 0-49）に変換します。これにより、後の乱数値との比較・照合が効率的に行えるようになります。

### 3. 全テーブル・全シード値の検証ループ

マクロの核心部分です。17個すべてのテーブルに対して、以下の検証処理を総当たりで実行します。

-   **テーブルループ (T1〜T17):** 17個のテーブルを順番に検証します。
-   **シード値ループ:** 各テーブルに含まれる5400以上のシード値（乱数の初期値）を一つずつ開始点として設定し、入力された報酬パターンと一致するかどうかを試します。

### 4. ���酬パターンの照合とシミュレーション

各シード値を開始点として、ゲーム内の報酬決定ロジックをシミュレートします。

1.  **スキル判定:**
    クエストごとに発動していたスキルに応じて、報酬枠が増えるかどうかの抽選に使われる閾値 (`lack`) を設定します。
    -   **激運:** 29/32
    -   **幸運:** 26/32
    -   **なし:** 22/32

2.  **報酬枠の抽選:**
    -   乱数シードテーブルから値を順番に取得します。
    -   `seed値 mod 32 >= lack` の条件を満たすと、その報酬枠はスキップ（ハズレ）と判定されます。
    -   `seed値 mod 100` で得られた値が、対象アイテムの抽選範囲内にあるかどうかで、報酬アイテムが一致するかを判定します。

3.  **乱数値の消費:**
    -   1回の抽選ごとに乱数値を消費し、テーブルの次の値を次の抽選で使用します。
    -   1回のクエスト（1試行）が終了するごとに、**固定消費値**の分だけ乱数インデックスを進めます。

### 5. 判定と結果表示

-   **適合判定:**
    入力された全ての試行（報酬パターン）が、あるシード値から始まる乱数列と矛盾なく一致した場合、そのテーブルは**「適合���○）」**と判断されます。
-   **結果の書き込み:**
    全てのテーブルの検証が完了した後、以下の結果をSheet1に書き込みます。
    -   **各テーブルの適合結果 (N3:AD3):** T1からT17まで、それぞれ「○」か「×」で表示。
    -   **予想されるテーブル (G19):** 適合したテーブルが1つだけの場合、そのテーブル番号（例: "T10"）を表示。複数適合、あるいは適合なしの場合は「-」や「該当なし」と表示。
    -   **開始シード値 (G18):** 適合したテーブルの開始シード値を表示。

### 6. 終了処理

最後に、Excelの自動計算設定を元に戻し、処理を完了します。

## ロジックの要点

-   **乱数消費のシミュレーション:** ゲーム内の複雑な乱数消費ロジックをExcel上で忠実に再現し、実際の報酬パターンと一致する乱数列を探し出します。
-   **総当たり探索:** 17個のテーブルと、各テーブルの膨大なシード値をすべて試す「ブルートフォース（総当たり）方式」で検証を行います。
-   **モジュロ演算の活用:** `Mod`演算子を多用して、乱数テーブルの値を循環させたり、特定の範囲の数値に変換したりしています。これは、ゲーム��乱数生成・消費ロジックで一般的に用いられる手法です。
